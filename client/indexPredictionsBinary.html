<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Previsões de Binário</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #LogDiv {
        background-color: #f9f9f9;
        padding: 20px;
        border: 1px solid #ddd;
        height: 400px;
        overflow-y: scroll;
      }
      .highlight {
        background-color: #ffeb3b;
        border-radius: 8px;
      }
      .prediction-block {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .prediction-details {
        background-color: #fff;
        padding: 10px;
      }
      .prediction-header {
        display: flex;
        padding: 10px;
        background-color: #fff;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px;
        margin-bottom: 1px;
        border-bottom: 1px solid #eee;
      }

      .prediction-details p {
        margin: 5px 0;
        border-radius: 4px;
      }

      .indicators ul {
        list-style: none;
        padding: 0;
        margin: 5px 0;
      }

      .indicators li {
        margin: 3px 0;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        padding: 15px;
      }

      .stat-item {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
      }

      .stat-item h3 {
        margin: 0 0 10px 0;
        color: #333;
      }

      .stat-details p {
        margin: 5px 0;
        color: #666;
      }

      /* Adicione uma mensagem para quando o sistema estiver offline */
      .offline-message {
        display: none;
        background-color: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        text-align: center;
      }

      .offline .offline-message {
        display: block;
      }
      .strong-signal {
        background-color: #4caf50;
        color: black;
      }
      .copy-button {
        margin-left: 10px;
        cursor: pointer;
        padding: 2px 5px;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        border-radius: 3px;
      }
      .history-item {
        margin: 10px 0;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 4px;
      }

      .history-timestamp {
        font-weight: bold;
        color: #666;
        margin-bottom: 5px;
      }

      .history-content {
        white-space: pre-wrap;
        font-family: monospace;
        background-color: #fff;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin: 0;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .indicators {
        background-color: #f0f0f0;
        padding: 10px;
        border-radius: 4px;
        margin-top: 1px;
      }
      .statistics {
        margin-top: 20px;
        padding: 10px;
        background-color: #e3f2fd;
        border-radius: 5px;
      }
      .controls {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      h1 {
        text-align: center;
      }
      .controls button {
        margin-right: 10px;
        padding: 5px 10px;
      }
      .filter-options {
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      /* Adicione ao bloco de estilos existente */
      .tooltip-container {
        position: relative;
        display: inline-block;
        margin-right: 20px;
      }

      .tooltip {
        visibility: hidden;
        width: 300px;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 10px;
        position: absolute;
        z-index: 1;
        top: 118%;
        left: 50%;
        margin-left: -150px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 14px;
        line-height: 1.4;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .tooltip::after {
        content: "";
        position: absolute;
        bottom: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
      }

      .tooltip-container:hover .tooltip {
        visibility: visible;
        opacity: 1;
      }

      /* Estilo adicional para melhorar a aparência dos controles */
      .filter-options label {
        padding: 5px 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        border: 1px solid #ddd;
      }

      .filter-options select,
      .filter-options input {
        margin-left: 5px;
        padding: 2px 5px;
      }
    </style>
  </head>
  <body>
    <h1>Previsões de Binário</h1>

    <div class="controls">
      <button id="enableSound">Ativar Som</button>
      <button id="viewHistory">Ver Histórico</button>
      <button id="viewStats">Ver Estatísticas</button>
    </div>

    <!-- Modifique a seção filter-options do HTML -->
    <div class="filter-options">
      <label class="tooltip-container">
        Score Mínimo:
        <select id="minScore">
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
        </select>
        <span class="tooltip">
          O Score (2-4) indica a força do sinal baseado em múltiplos
          indicadores:<br />
          • MACD positivo: +1 ponto<br />
          • RSI em zona de sobrecompra/sobrevenda: +1 ponto<br />
          • Tendência forte: +1 ponto<br />
          • Bollinger Bands: +1 ponto<br />
          Quanto maior o score, mais confiável é o sinal.
        </span>
      </label>

      <label class="tooltip-container">
        Precisão Mínima:
        <input type="number" id="minAccuracy" value="75" min="0" max="100" />%
        <span class="tooltip">
          A Precisão (0-100%) representa a taxa de acerto histórica das
          previsões.<br />
          Baseada no histórico de previsões anteriores para este ativo.<br />
          Valores mais altos indicam maior confiabilidade histórica.
        </span>
      </label>
    </div>

    <div id="LogDiv">
      <div id="log"></div>
    </div>
    <div class="offline-message">
      O sistema está temporariamente offline. Aguarde alguns instantes...
    </div>

    <audio id="alertSound" src="sound2.mp3" preload="auto"></audio>

    <!-- Modal para Histórico -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Histórico de Ativos Copiados</h2>
        <div id="historyContent"></div>
      </div>
    </div>

    <!-- Modal para Estatísticas -->
    <div id="statsModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Estatísticas (24h)</h2>
        <div id="statsContent"></div>
      </div>
    </div>

    <script>
      // Adicione no início do script
      let isOffline = false;

      // Detectar quando o sistema fica offline/online
      function checkConnection() {
        fetch("/previsaoBinary/status")
          .then((response) => response.json())
          .then((status) => {
            isOffline = !status.connected;
            document.body.classList.toggle("offline", isOffline);
          })
          .catch(() => {
            isOffline = true;
            document.body.classList.add("offline");
          });
      }

      // Verificar conexão a cada minuto
      setInterval(checkConnection, 60000);
      checkConnection();

      let soundEnabled = false;
      let tempo = 1;
      let copiedAssets = [];

      document.getElementById("enableSound").addEventListener("click", () => {
        soundEnabled = !soundEnabled;
        document.getElementById("enableSound").textContent = soundEnabled
          ? "Desativar Som"
          : "Ativar Som";
      });

      function copyAsset(symbol, blockText) {
        copiedAssets.push({
          timestamp: new Date(),
          content:
            typeof blockText === "string"
              ? blockText
              : blockText.innerText || blockText.textContent,
        });

        navigator.clipboard
          .writeText(symbol)
          .then(() => {
            console.log(
              `Ativo ${symbol} copiado para a área de transferência.`
            );
          })
          .catch((err) => {
            console.error("Erro ao copiar texto: ", err);
          });
      }

      function formatIndicators(indicators) {
        return `
                  <div class="indicators">
            <strong>Indicadores Técnicos:</strong>
            <ul>
                <li>RSI: ${indicators.rsi.toFixed(2)}</li>
                <li>Bollinger Bands: Upper ${indicators.bb.upper.toFixed(
                  5
                )} / Lower ${indicators.bb.lower.toFixed(5)}</li>
                <li>Tendência: ${indicators.trend} (${
          indicators.isTrendStrong ? "Forte" : "Fraca"
        })</li>
            </ul>
        </div>
      `;
      }

      function fetchPredictions() {
        const minScore = parseInt(document.getElementById("minScore").value);
        const minAccuracy = parseInt(
          document.getElementById("minAccuracy").value
        );

        fetch("/previsaoBinary/predictions")
          .then((response) => response.json())
          .then((data) => {
            const logDiv = document.getElementById("log");
            logDiv.innerHTML = ""; // Limpar entradas anteriores

            if (data.length === 0) {
              const noDataEntry = document.createElement("div");
              noDataEntry.textContent = "Aguardando sinais...";
              logDiv.appendChild(noDataEntry);
            } else {
              data.forEach((prediction) => {
                const logEntry = document.createElement("div");

                const blockText = `
                        <div class="prediction-block">
                            <div class="prediction-header">
                                <strong>Ativo:</strong> ${prediction.symbol}
                                <button class="copy-button" onclick="copyAsset('${
                                  prediction.symbol
                                }', this.parentElement)">
                                    Copiar Ativo
                                </button>
                            </div>
                            <div class="prediction-details">
                                <p><strong>Preço Atual:</strong> ${
                                  prediction.currentPrice
                                }</p>
                                <p><strong>Direção:</strong> ${
                                  prediction.predictedDirection
                                }</p>
                                <p><strong>Tempo de Expiração:</strong> ${
                                  prediction.expirationTime
                                }</p>
                                <p><strong>Score do Sinal:</strong> ${
                                  prediction.signalScore
                                }</p>
                            </div>
                            ${formatIndicators(prediction.indicators)}
                        </div>
                    `;

                logEntry.innerHTML = blockText;

                if (prediction.signalScore >= 3) {
                  logEntry.classList.add("strong-signal");
                }

                if (prediction.signalScore >= 3 && soundEnabled) {
                  document.getElementById("alertSound").play();
                  setTimeout(myStopFunction, 2000);
                }

                logDiv.appendChild(logEntry);
              });
            }
          })
          .catch((error) => {
            console.error("Erro ao buscar previsões:", error);
            document.body.classList.add("offline");
          });
      }

      function fetchStatistics() {
        fetch("/previsaoBinary/statistics")
          .then((response) => response.json())
          .then((data) => {
            const statsContent = document.getElementById("statsContent");
            statsContent.innerHTML = `
                <div class="stats-grid">
                    ${data
                      .map(
                        (stat) => `
                        <div class="stat-item">
                            <h3>${stat.symbol}</h3>
                            <div class="stat-details">
                                <p>Total de Previsões: ${
                                  stat.total_predictions
                                }</p>
                                <p>Score Médio: ${stat.avg_score.toFixed(2)}</p>
                            </div>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `;
          })
          .catch((error) =>
            console.error("Erro ao buscar estatísticas:", error)
          );
      }

      function myStopFunction() {
        const alertSound = document.getElementById("alertSound");
        alertSound.pause();
        alertSound.currentTime = 0;
      }

      // Configuração dos modais
      const historyModal = document.getElementById("historyModal");
      const statsModal = document.getElementById("statsModal");
      const closeButtons = document.getElementsByClassName("close");

      document.getElementById("viewHistory").onclick = function () {
        const historyContent = document.getElementById("historyContent");
        historyContent.innerHTML = copiedAssets
          .map(
            (item) => `
            <div class="history-item">
                <div class="history-timestamp">${item.timestamp.toLocaleString()}</div>
                <pre class="history-content">${item.content}</pre>
            </div>
        `
          )
          .join("<hr>");
        historyModal.style.display = "block";
      };

      document.getElementById("viewStats").onclick = function () {
        fetchStatistics();
        statsModal.style.display = "block";
      };

      Array.from(closeButtons).forEach((button) => {
        button.onclick = function () {
          historyModal.style.display = "none";
          statsModal.style.display = "none";
        };
      });

      window.onclick = function (event) {
        if (event.target == historyModal) {
          historyModal.style.display = "none";
        }
        if (event.target == statsModal) {
          statsModal.style.display = "none";
        }
      };

      // Inicialização
      setInterval(fetchPredictions, 10000); // 10 segundos
      fetchPredictions();

      // Atualizar quando os filtros mudarem
      document
        .getElementById("minScore")
        .addEventListener("change", fetchPredictions);
      document
        .getElementById("minAccuracy")
        .addEventListener("change", fetchPredictions);
    </script>
  </body>
</html>
